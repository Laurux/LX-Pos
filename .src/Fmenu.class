' Gambas class file

'#######################################################
'# Modification Marc GUILLAUME <alarch@alarch.ath.cx>
'# pour utilisation d'un tunnel ssh de connexion MySQL
'# 07 janvier 2010
'########################################################

Public Soc As String
Public intitule As String
Public Version As String
hForm As Fondcaisse
Ncaisse As String
Efface As Integer = 1

Public Sub _new()
  
  Dim titre As String
  Dim $con_ok As Boolean = True ' flag d'autorisation de connexion
  
  Me.Center
  Me.Width = Screens[0].width
  Me.Height = Screens[0].Height
  Settings["/Cai" & "/Ncai"] = "1"
  Settings.Save
  titre = fmenu.text
  Try intitule = Settings["/intitule"]
  'Fmenu.text = titre & " ( Société  " " " & Right$(Soc, 2) & " - " & intitule & ") "
  Try Version = Settings["/dbase/Version"]
  Try Soc = Settings["/Soc"]
  TextLabel1.text = "Vous êtes sur le poste " & System.host & "<BR> Vous êtes connecté sur la société :<BR>" & Soc & " " & intitule
  If Settings["/raccourcis"] Then
    Label2.visible = False
    Label3.visible = False
    Label4.visible = False
    Label5.visible = False
  Endif
  '# -- initialisation des informations SQL
  '* MG - 07 janvier 2010
  Utils.glb()
  
  '# -- montage éventuel du tunnel ssh
  '* MG - 07 janvier 2010
  If Settings["/dbase/Con-ssh"] Then
    If Not Utils.monteTunnel() Then
      $con_ok = False
    Endif
  Endif
  
  If $con_ok Then
    Utils.db.Open
    Utils.db.exec("SET NAMES 'latin1'")
    Fmenu.text = titre & " ( Société  " " " & Right$(Soc, 2) & " - " & intitule & ") "
  Else
    Message.Warning("Le tunnel SSH n'a pu être établi, la connexion SQL est impossible")
    Config()
  Endif
Catch
  If Start.son Then
    music.Play
  Endif
  If Left$(error.Text, 19) = "Driver name missing" Then
    Message.Warning("Attention, le fichier de configuration n'existe pas ! \n Veuillez completer les zones nécéssaires à sa création SVP !")
  Else
    If Left$(error.Text, 13) = "type mismatch" Then
      Message.Warning("Attention, le fichier de configuration n'existe pas ou est corrompu !")
    Else
      If Left$(error.Text, 27) = "Cannot open database: Acces" Then
        Message.Warning("Attention, l' utilisateur ou le mot de passe est erroné ! \n Veuillez controler votre saisie SVP !")
      Else
        If Left$(error.Text, 38) = "Cannot open database: Unknown database" Then
          Message.Warning("Attention, la base n'existe pas ou son adresse n'est pas bonne !")
        Else
          message.Error(Error.Text & " " & Error.Where)
        Endif
      Endif
    Endif
  Endif
  Config()
  
End

Public Sub Button1_Click()
  
  Ouverture.ShowModal()
  
End

Public Sub Button1_Click2()
  
  Dim rResult As Result
  Dim tab As String
  Dim b As Integer = 1
  
  Tab = "Fiches_ClientCaisse"
  Try rResult = Utils.db.Exec("SELECT * FROM " & tab & "")
  If Not Error Then
    If Not rResult.Available Then
      If Start.son Then
        Music.Play
      Endif
      Message.Warning("Attention, Vous n'avez pas selectionné le client caisse !")
      b = 0
    Endif
    rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCaisses") & " where poste = &1 ", System.host)
    If Not rResult.Available Then
      message.Warning("Il faut d'abord créer vos caisses par la table des caisses sous LX.pos !")
      b = 0
    Endif
    If b = 1 Then Ouverture.ShowModal()
  Else
    If Start.son Then
      Music.Play
    Endif
    Message.Warning("Attention, Vous n'avez pas selectionné le client caisse !")
    b = 0
  Endif
  
End

Public Sub Button2_Click()
  
  SauvesAuto.Sauvegarde
  Me.close
  
End

Public Sub form_close()
  
  Try Kill User.home & "/Caisse.lock"
  Utils.fermeTunnel()
  Utils.db.Close
  
End

Public Sub Button2_KeyPress()
  
  If Key.code = Key.F1 Then Visdoc.Web(Application.Path &/ "Doc_Caisse/LX.PosIndexParCategories.html")
  If key.Control Then
    If Key.code = Key.F2 Then Fsoc.ShowModal()
    If Key.code = Key.F3 Then Preferences.ShowModal()
    If Key.code = Key.F4 Then Attrib.ShowModal()
    If Key.code = Key.F5 Then Fcaisses.ShowModal()
    If Key.code = Key.F6 Then Frestore.ShowModal()
  Endif
  If key.code = key.Enter Or key.code = key.Return Then Button2_Click()
  
End

Public Sub Button10_Click()
  
  If IsNull(Settings["/Cai" & "/Ncai"]) Then
    If Start.son Then
      Music.Play
    Endif
    Message.Error("La caisse n'est pas connectée!\n Veuillez connecter votre caisse avant de saisir le fond de caisse SVP")
  Else
    hForm = New Fondcaisse("")
    hForm.Showmodal()
  Endif
  
End

Public Sub Button10_KeyPress()
  
  If Key.code = Key.F1 Then Visdoc.Web(Application.Path &/ "Doc_Caisse/LX.PosIndexParCategories.html")
  If key.Control Then
    If Key.code = Key.F2 Then Fsoc.ShowModal()
    If Key.code = Key.F3 Then Preferences.ShowModal()
    If Key.code = Key.F4 Then Attrib.ShowModal()
    If Key.code = Key.F5 Then Fcaisses.ShowModal()
    If Key.code = Key.F6 Then Frestore.ShowModal()
  Endif
  If key.code = key.Enter Or key.code = key.Return Then Button10_Click()
  
End

Public Sub Button11_Click()
  
  If IsNull(Settings["/Cai" & "/Ncai"]) Then
    If Start.son Then
      Music.Play
    Endif
    Message.Error("La caisse n'est pas connectée!\n Veuillez connecter votre caisse avant d'aller en saisie SVP")
  Else
    ViseurT.center
    ViseurT.Caption = "Viseur client"
    'Desktop.Current = 1
    'ViseurT.Show()
    'Desktop.Current = 0
    Caisse.ShowModal()
  Endif
  
End

Public Sub Button11_KeyPress()
  
  If Key.code = Key.F1 Then Visdoc.Web(Application.Path &/ "Doc_Caisse/LX.PosIndexParCategories.html")
  If key.Control Then
    If Key.code = Key.F2 Then Fsoc.ShowModal()
    If Key.code = Key.F3 Then Preferences.ShowModal()
    If Key.code = Key.F4 Then Attrib.ShowModal()
    If Key.code = Key.F5 Then Fcaisses.ShowModal()
    If Key.code = Key.F6 Then Frestore.ShowModal()
    If key.code = key.Enter Or key.code = key.Return Then Button11_Click()
  Endif
  
End

Public Sub Config()
  
  LXConf.ShowModal()
  
End

Public Sub Button1_KeyPress()
  
  If Key.code = Key.F1 Then Visdoc.Web(Application.Path &/ "Doc_Caisse/LX.PosIndexParCategories.html")
  If key.Control Then
    If Key.code = Key.F2 Then Fsoc.ShowModal()
    If Key.code = Key.F3 Then Preferences.ShowModal()
    If Key.code = Key.F4 Then Attrib.ShowModal()
    If Key.code = Key.F5 Then Fcaisses.ShowModal()
    If Key.code = Key.F6 Then Frestore.ShowModal()
  Endif
  If key.code = key.Enter Or key.code = key.Return Then Button1_Click()
  
End

Public Sub FORM_KeyPress()
  
  If key.Alt Then
    If key.code = 80 Then mdp_admin2()
  Endif
  
End

Public Sub mdp_admin2()
  
  If Settings["/admin2"] = True Then
    Mdp.Clear
    Frame8.visible = True
    Mdp.SetFocus
  Else
    Preferences.ShowModal()
    Try intitule = Settings["/intitule"]
    Try Version = Settings["/dbase/Version"]
    Try Soc = Settings["/Soc"]
    TextLabel1.text = "Vous êtes sur le poste " & System.host & "<BR> Vous êtes connecté sur la société :<BR>" & Soc & " " & intitule
  Endif
  
End

'*******************************************************
'*          On gère le mot de passe admin               *
'*******************************************************

Public Sub Mdp_KeyPress()
  
  Dim rResult As Result
  Dim mdpadmin As String
  Dim admin As Integer
  
  If Key.Code = Key.Return Or If Key.Code = Key.Enter Then
    rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabVendeurs") & " where admin = &1", "-1")
    If rResult.Available Then
      For Each rResult
        mdpadmin = hexdblKey.crypt("de", rResult!mdp, "LXpos")
        If mdpadmin = Mdp.Text Then
          admin = 1
          Mdp.Clear
          Frame8.visible = False
          Preferences.ShowModal()
          Break
        Endif
      Next
      If admin = 0 Then
        If Start.son Then
          Music.Play
        Endif
        Message.Error("Le mot de passe n'est pas valable ! Vérifiez votre saisie SVP !")
        Mdp.Select
      Endif
    Else
      If Start.son Then
        Music.Play
      Endif
      Message.Warning("Aucun administrateur n'a été déclaré dans la table des vendeurs !")
      Mdp.Clear
      Frame8.visible = False
    Endif
  Else
    If key.code = key.Esc Then
      Mdp.Clear
      Frame8.visible = False
    Endif
  Endif
  
End

Public Sub init_ecole()
  
  Dim Tabx As String
  Dim Tabz As String
  Dim Tabtx As String
  Dim Tabrgx As String
  Dim Tabrgz As String
  Dim Tiketx As String
  Dim Tiketz As String
  
  Tabx = "Fiches_EntTickets" & Ncaisse
  Tabz = "Fiches_EntTicketz"
  Tiketx = "Fiches_LigTickets" & Ncaisse
  Tiketz = "Fiches_LigTicketz"
  Tabrgx = "Fiches_Reglts" & Ncaisse
  Tabrgz = "Fiches_Regltz" & Ncaisse
  Tabtx = "Fiches_Ticketx" & Ncaisse
  If Start.son Then
    Music.Play
  Endif
  If message.Question("Attention ! Quitter la caisse école va remettre les fichiers de caisse à zéro. Voulez-vous quitter ?", "Oui", "Non") = 1 Then
    ' on efface
    Efface = 1
    Utils.db.Exec("drop Table IF exists " & Tabx & "")
    ' on recréée
    Try Utils.db.EXEC("CREATE TABLE " & Tabx &
      "(lInd INT NOT NULL AUTO_INCREMENT," &
      "caisse Char(1)," &
      "numero Char(7)," &
      "vendeur Char(35)," &
      "date Char(17)," &
      "client Char(30)," &
      "scheque Char(1)," &
      "mcheque Char(12)," &
      "nmcheque Char(30)," &
      "scarte  Char(1)," &
      "nmcarte Char(30)," &
      "mcarte Char(12)," &
      "sespeces Char(1)," &
      "mespeces Char(12)," &
      "scredit  Char(1)," &
      "mcredit Char(12)," &
      "nmcredit Char(30)," &
      "sbachat  Char(1)," &
      "mbachat Char(12)," &
      "scavoir  Char(1)," &
      "mavoir Char(12)," &
      "nmavoir Char(30)," &
      "mht Char(12)," &
      "mtva Char(12)," &
      "mttc Char(12)," &
      "statut Char(1)," &
      "savoir Char(1) ," &
      "type Char(1) ," &
      "PRIMARY KEY (lInd))")
    
    Utils.db.Exec("drop Table IF exists " & Tiketx & "")
    Try Utils.db.EXEC("CREATE TABLE " & Tiketx &
      "(lInd INT NOT NULL AUTO_INCREMENT," &
      "numero Char(7)," &
      "numlig Char(3)," &
      "code Char(15)," &
      "intitule  Char(50)," &
      "montant Char(12)," &
      "qte Char(12)," &
      "type Char(1)," &
      "fam Char(5)," &
      "mht Char(12)," &
      "mrem Char(12)," &
      "PRIMARY KEY (lInd))")
    
    Utils.db.Exec("drop Table IF exists " & Tabrgx & "")
    Try Utils.db.EXEC("CREATE TABLE " & Tabrgx &
      "(lInd INT NOT NULL AUTO_INCREMENT," &
      "intitule Char(30)," &
      "montant Char(12)," &
      "qte Char(12)," &
      "type Char(15)," &
      "PRIMARY KEY (lInd))")
    
    Utils.db.Exec("drop Table IF exists " & Tabtx & "")
    Try Utils.db.EXEC("CREATE TABLE " & Tabtx &
      "(lInd INT NOT NULL AUTO_INCREMENT," &
      "numero Char(7)," &
      "fam Char(5)," &
      "montant Char(12)," &
      "qte Char(12)," &
      "PRIMARY KEY (lInd))")
    
    'on met à jour le flag de la bande z ainsi que le fond de caisse
    Utils.db.Exec("UPDATE  " & Cbase.Table("TabCaisses") & "  SET tkz = &2, fndc = &3, dtefm = &4, connecte = &5 WHERE code = &1", Ncaisse, 0, 0, "", 0)
    Try Kill User.home & "/" & "Caisse.lock"
    If Start.son Then
      Music.Play
    Endif
    message.Info("Traitement terminé !")
  Else
    Efface = 0
    Stop Event
  Endif
  
End

Public Sub Label1_MouseDown()
  
  Visdoc.Web(Application.Path &/ "Doc_Caisse/LX.PosIndexParCategories.html")
  
End

Public Sub Label2_MouseDown()
  
  mdp_admin2()
  
End
