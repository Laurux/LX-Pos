' Gambas class file

Public btn As ImageButton
Public Bsel As Boolean = False
Public fnd As String
Private Touche_P As String
Private Touche_S As String
Private CodeA As New String[36]
Private TvaA As New String[36]
Private ToucheS As New String[36]
Private hpan As Panel
Private hbutton As ImageButton
Private Pan As Boolean = False
Private Fam As String

Public Sub Form_Open()
  
  Init()
  createPanel()
  
End

Public Sub createPanel()
  
  hpan = New Panel(Panel1)
  hpan.W = Panel1.w
  hpan.H = Panel1.H
  hpan.x = 0
  hpan.Y = 0
  'hpan.border = Border.Etched
  hpan.Background = &HE7FFDF&
  hpan.visible = False
  
End

Public Sub Init()
  
  Dim rTch As Result 
  Dim i As Integer
  Dim t As String = "A"
  
  For i = 1 To 36
    t = "A" & i
    Try btn = Me.Controls[t]
    Try btn.Text = ""
  Next
  rTch = Utils.db.Exec("SELECT * From " & Cbase.Table("TabTouches") & " where left(touche,1) = &1 order by touche", "A")
  If rTch.Available Then
    Repeat
      Try Me.Controls[rTch!touche].Name = rTch!touche
      If Not Error Then
        Btn = Me.Controls[rTch!touche]
        btn.Text = rTch!libelle
        CodeA[btn.tag] = rTch!code
        TvaA[btn.tag] = rTch!tva
        ToucheS[btn.tag] = Utils.convBool(rTch!touche_s)
        Try Btn.Background = rTch!coul
        Try btn.Picture = Picture[rTch!fond]
      Endif
    Until rTch.MoveNext()
  Endif
  Bouton.Clear
  TextArea1.Clear
  Cart.clear
  Tva.clear
  CheckBox1.value = False
  
End

Public Sub Button2_Click()
  
  Me.close
  
End

Public Sub Clav2_Click()
  
  'If Last.tag <> 30 Then
  TextArea1.Clear
  TextArea1.Text = Last.text
  Bouton.Text = Last.name
  Cart.Text = CodeA[Last.tag]
  If IsNull(Cart.text) Then Cart.Text = Right$(Bouton.Text, Len(Bouton.Text) - 1)
  Tva.text = TvaA[Last.tag]
  Try CheckBox1.value = ToucheS[Last.tag]
  Touche_P = Last.name
  Fam = Cart.Text
  fnd = Touche_P
  TextArea1.Select
  TextArea1.setfocus
  'Endif 
  
End

Public Sub Button1_Click()
  
  Dim rTch As Result
  
  If Not IsNull(Cart.Text) And Not IsNull(Bouton.Text) And Not IsNull(Tva.text) Then
    rTch = Utils.db.Exec("SELECT * From " & Cbase.Table("TabTouches") & " where touche = &1", Bouton.Text)
    If rTch.Available Then
      Utils.db.Exec("UPDATE " & Cbase.Table("TabTouches") & " set libelle = &1, code = &2, tva = &4, touche_s = &5 where touche = &3", TextArea1.text, Cart.Text, Bouton.Text, Tva.text, CheckBox1.value)
    Else
      Utils.db.Exec("INSERT INTO " & Cbase.Table("TabTouches") & " (touche, libelle, code, tva, touche_s) VALUES (&1, &2, &3, &4, &5)", Bouton.Text, TextArea1.text, Cart.Text, Tva.text, CheckBox1.value)
    Endif
    Btn = Me.Controls[Bouton.Text]
    btn.text = ""
    Btn.Refresh
    If Not pan Then
      Init()
    Else
      Init2()
    Endif
  Else
    Message.Error("Veuillez vérifier votre saisie SVP !")
  Endif
  
End

Public Sub Bouton_KeyPress()
  
  If Key.code = Key.Del Then
    If Not IsNull(Bouton.Text) Then
      Utils.db.Exec("delete  From " & Cbase.Table("TabTouches") & " where touche = &1", Bouton.Text)
      Me.Controls[Bouton.Text].Name = Bouton.Text
      Btn = Me.Controls[Bouton.Text]
      btn.text = ""
      Btn.Refresh
      If hpan.visible = False Then
        Init()
      Else
        Init2()
      Endif
    Endif
  Endif 
  
End

Public Sub Clav2_Dblclick()
  
  Fond_ImageButton()
  
End

Public Sub Fond_ImageButton()
  
  Dim hFormat As CFormat
  Dim hCont As ImageButton
  Dim Couleur As Long
  Dim rTch As Result
  
  Try hCont = Last
  If Not Error Then
    btn = Last
    hFormat = CFormat[Settings[hCont.tag]]
    FSetFormat.Format = hFormat
    FSetFormat.Run()
    hFormat = FSetFormat.Format
    hCont.Background = IIf(hFormat.Background = -1, color.TextBackground, hFormat.Background)
    Couleur = hCont.Background
    hCont.Foreground = IIf(hFormat.Foreground = -1, color.TextForeground, hFormat.Foreground)
    rTch = Utils.db.Exec("SELECT * From " & Cbase.Table("TabTouches") & " where touche = &1", Bouton.Text)
    If rTch.Available Then
      Utils.db.Exec("UPDATE " & Cbase.Table("TabTouches") & " set coul = &1 where touche = &2", hCont.background, Bouton.Text)
    Else
      Try Utils.db.Exec("INSERT INTO " & Cbase.Table("TabTouches") & " (touche, libelle, code, tva, coul) VALUES (&1, &2, &3, &4, &5)", Bouton.Text, TextArea1.text, Cart.Text, Tva.text, hCont.background)
    Endif
    If hpan.visible = False Then
      Init()
    Else
      Init2()
    Endif
  Endif
  
End

Public Sub Button3_Click()
  
  If IsNull(Bouton.text) And Not pan Then
    Message.Warning("Veuillez saisir une famille SVP !")
  Else
    If pan Then
      Bouton.Clear
      TextArea1.Clear
      Cart.clear
      Tva.clear
      CheckBox1.value = False
      hpan.Delete
      Pan = False
      Button3.Text = "Sous-familles"
    Else
      If Not pan Then
        Bouton.Clear
        TextArea1.Clear
        Cart.clear
        Tva.clear
        createPanel()
        hpan.visible = True
        Cbutton(Panel1)
        Pan = True
        Button3.Text = "Familles"
      Endif
    Endif
  Endif
Catch
  
End

'****************************************************
'*      Création des boutons des sous-familles      *
'****************************************************
Public Sub Cbutton(oObj As Object)
  
  Dim hClass As Object
  
  For Each hClass In oObj.Children
    If hClass.Tag Then
      Hbutton = New (ImageButton, hpan) As "Clav3"
      hbutton.Name = Touche_P & "B" & Right$(hClass.Name, Len(hClass.name) - 1)
      hbutton.W = hClass.w
      hbutton.H = hClass.H
      hbutton.x = hClass.x
      hbutton.Y = hClass.y
      hbutton.Tag = hClass.tag
    Endif
  Next
  Pan = True
  Init2()
  
End

Public Sub Clav3_Click()
  
  TextArea1.Clear
  TextArea1.Text = Last.text
  Bouton.Text = Last.name
  Cart.Text = CodeA[Last.tag]
  If IsNull(Cart.Text) Then Cart.Text = fam
  Tva.text = TvaA[Last.tag]
  Touche_S = Last.name
  Fnd = Touche_S
  TextArea1.Select
  TextArea1.setfocus
  
End

Public Sub Clav3_Dblclick()
  
  Fond_ImageButton()
  
End

Public Sub Init2()
  
  Dim rTch As Result 
  Dim i As Integer
  Dim t As String = "B"
  
  For i = 1 To 35
    t = "B" & i
    Try btn = Me.Controls[t]
    Try btn.Text = ""
  Next
  i = Len(Touche_P)
  rTch = Utils.db.Exec("SELECT * From " & Cbase.Table("TabTouches") & " order by touche")
  If rTch.Available Then
    Repeat
      If Left(rTch!touche, i) = Touche_p And InStr(rTch!touche, "B") <> 0 Then
        Try Me.Controls[rTch!touche].Name = rTch!touche
        If Not Error Then
          Btn = Me.Controls[rTch!touche]
          btn.Text = rTch!libelle
          CodeA[btn.tag] = rTch!code
          TvaA[btn.tag] = rTch!tva
          Try Btn.Background = rTch!coul
          Try btn.Picture = Picture[rTch!fond]
        Endif
      Endif
    Until rTch.MoveNext()
  Endif
  Bouton.Clear
  TextArea1.Clear
  Cart.clear
  Tva.clear
  
End

Public Sub CheckBox1_Click()
  
  If CheckBox1.Value Then
    Button3.Visible = True
  Else
    Button3.Visible = False
  Endif
  
End
