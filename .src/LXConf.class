' Gambas class file

'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : LXConf.class
'# Auteur                   : Jacky Tripoteau
'# Gestion du fichier de configuration
'################################################
'
Public Hwnd As Fmenu
Public hcon As New Connection
Public Soc As String
Public intitule As String
Public Fonte As Integer
Public Version As String
Public Hfile As File
Public d As String
Static Public DB As New Connection
Public lnd As Integer
Public Lig As String
Public Key As String
Public iPos As Integer
Public rResult As Result

Public Sub _new()

  Dim Frmt As String[]
  Dim ssh As String

  Frmt = Utils.FColr(Settings["/Coul/Fnets"])
  If Settings["/Soc" & Start.Soc & "/Coul_fen"] = 0 Then Me.Background = Val(Frmt[0])
  Utils.Observers(LXConf)
  Try Music.Load("son/warning.ogg")
  Me.Center
  Try ssh = Settings["/dbase/Con-ssh"]
  If ssh <> 0 And Not IsNull(ssh) Then
    Bssh.value = True
    Bssh_Click()
  Endif

End

'***********************************************************
'* La connexion se fait sans mot de passe, la clé publique
'* de l'utilisateur doit se trouver sur le serveur SQL
'* contacté en SSH
'* MG - 07 janvier 2010
'***********************************************************
Public Sub Button1_Click()

  Dim $ready_connect As Boolean

  $ready_connect = True
  Soc = "01"
  intitule = "  "
  Settings["/dbase/Version"] = "LX.pos V1.3"
  '# -- Partie commune aux connexions avec ou sans tunnel
  Settings["/dbase/type"] = "mysql"
  Settings["/dbase/Name"] = "Caisse"
  Settings["/dbase/Login"] = login.Text
  Settings["/dbase/Password"] = hexdblKey.crypt("en", Password.Text, "LXpos")
  Settings["/dbase/Port"] = Port.Text
  Settings["/dbase/Host"] = Host.Text
  Settings["/Soc"] = Soc
  Settings["/intitule"] = intitule
  Settings["/son"] = 0
  Settings["/Tips"] = 1
  Settings["/tactile"] = 0
  Settings.Save

  '# -- valeurs de connexion
  hcon.type = Settings["/dbase/type"]
  ' le nom est celui de la base
  hcon.Name = Settings["/dbase/Name"]
  ' le login est celui de la base
  hcon.Login = Settings["/dbase/Login"]
  ' le mot de passe est celui de la base
  hcon.Password = hexdblKey.crypt("de", Settings["/dbase/Password"], "LXpos")
  ' l'hôte à utiliser est le serveur MySQL
  hcon.Host = Settings["/dbase/Host"]
  ' le port le port MySQL du serveur
  hcon.Port = Settings["/dbase/Port"]

  Soc = Settings["/Soc"]
  Try hcon.Close
  hcon.Open
  Settings["/Cai" & "/Ncai"] = 1
  Settings.Save
  Try Utils.db.exec("SET NAMES 'latin1'")
  If Not Error Then
    If Message.Info("Le fichier de configuration a été crée ou modifié. Veuillez relancer LX.pos SVP.", "OK!") = 1 Then
      Button2_Click()
      Quit
    Endif
  Else
    Createbase()
  Endif
Catch
  If Left$(error.Text, 35) = "Cannot open database: Access denied" Then
    Message.Warning("Attention, l' utilisateur ou le mot de passe est erroné ! \n Veuillez controler votre saisie SVP et vérifier que l'utisateur soit bien créé dans MySQL!")
  Else
    If Left$(error.Text, 38) = "Cannot open database: Unknown database" Then
      Message.Warning("Attention, la base n'existe pas sur le serveur sélectionné !")
      Createbase()
    Else
      If Left$(error.Text, 35) = "Cannot open database: Can't connect" Then
        Message.Warning("Attention, accès MySQL impossible ! \n Veuillez vérifier que MySQL soit bien installé et que le service soit lancé SVP !")
      Else
        message.Error(Error.Text & " " & Error.Where)
      Endif
    Endif
  Endif

End

Public Sub createbase()

  Dim hcon As New Connection

  If message.Question("Le programme va créer la base Caisse", "Oui", "Non") = 1 Then
    Me.mouse = Mouse.wait
    Try Utils.db.Close

    hcon.type = "mysql"
    hcon.Name = ""
    hcon.Login = Login.Text
    hcon.Password = Password.Text
    hcon.Host = Host.Text
    hcon.Port = Port.Text
    Try hcon.open
    If Error Then Print Error.Text
    Try hcon.Databases.Add("Caisse")
    Try hcon.Close
    Settings["/Soc"] = "01"
    Settings["/intitule"] = "Caisse"
    If IsNull(Settings["/dbase/Host"]) Then
      Shell "mysql -u " & Utils.db.login & " -p" & Utils.db.Password & " " & "Caisse  < ~/LX.pos/Caisse.sql" Wait
    Else
      Shell "mysql -h " & Settings["/dbase/Host"] & " -u " & Utils.db.login & " -p" & Utils.db.Password & " " & "Caisse  < ~/LX.pos/Caisse.sql" Wait
    Endif
    Settings.Reload
    Try Start.societe = soc
    Me.mouse = Mouse.Default
    Message.Info("LX.pos est installé et la base de démarrage a été restaurée !\nVous pouvez maintenant travailler avec LX.pos.")
    Me.close
  Endif

End

Public Sub Button2_Click()

  Try Kill User.home & "/Caisse.lock"
  Me.close

End

'********************************************************************
'* Fermeture du formulaire avec suppression de l'éventuel tunnel ssh
'* MG - 07 janvier 2010
'********************************************************************
Public Sub Form_Close()

  Utils.fermeTunnel()
  Print Now & " - " & "Fermeture de la fenêtre\n"

End

'******************************************
'* Masquage affichage du cadre tunnel ssh
'* MG - 07 janvier 2010
'******************************************
Public Sub Bssh_Click()

  If Bssh.value Then
    Frame1.Enabled = True
  Else
    Frame1.Enabled = False
  Endif

End
